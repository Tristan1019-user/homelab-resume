{
	# CrowdSec global configuration
	crowdsec {
		api_url http://10.0.1.23:8080
		api_key YOUR_CROWDSEC_BOUNCER_API_KEY
		ticker_interval 15s
		disable_streaming
	}

	email your-email@example.com

	# Caddy internal logs (errors, startup, etc.)
	log {
		output file /var/log/caddy/caddy.log {
			roll_size 20mb
			roll_keep 5
		}
		format json
	}
}

# Reusable TLS snippet
(cloudflare_tls) {
	tls /etc/caddy/certs/wildcard-fullchain.cer /etc/caddy/certs/wildcard.key
}

# HTTP access log snippet - import into every site
(access_log) {
	log {
		output file /var/log/caddy/access.log {
			roll_size 50mb
			roll_keep 7
		}
		format json
	}
}

# Authentik forward auth snippet (domain-level SSO for *.example.internal)
(authentik) {
	# Pass outpost paths (ping, sign-out, callback) directly to Authentik - no auth check
	@ak_outpost path /outpost.goauthentik.io/*
	handle @ak_outpost {
		reverse_proxy 10.0.1.100:9000
	}
	# Require auth for all other paths
	@ak_protected not path /outpost.goauthentik.io/*
	forward_auth @ak_protected 10.0.1.100:9000 {
		uri /outpost.goauthentik.io/auth/caddy
		copy_headers X-authentik-username X-authentik-groups X-authentik-email X-authentik-name X-authentik-uid X-authentik-jwt X-authentik-meta-jwks X-authentik-meta-outpost X-authentik-meta-provider X-authentik-meta-app X-authentik-meta-version
	}
}

# --- Media ---

jellyfin.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		reverse_proxy 10.0.1.100:8096 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

overseerr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:5055 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

# --- Infrastructure ---

authentik.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		reverse_proxy 10.0.1.100:9000 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

uptimekuma.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.17:3001 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

# --- Apps ---

vaultwarden.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		reverse_proxy 10.0.1.100:4743 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

n8n.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		# Webhooks and API push endpoints must bypass SSO
		@n8n_public path /webhook/* /webhook-test/* /api/v1/push/*
		handle @n8n_public {
			reverse_proxy 10.0.1.100:5678 {
				header_up X-Forwarded-Proto https
				header_up X-Forwarded-Port 443
			}
		}
		import authentik
		reverse_proxy 10.0.1.100:5678 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

notifiarr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:5455 {
			header_up X-Forwarded-Proto https
			header_up X-Forwarded-Port 443
		}
	}
}

# --- Special Cases ---

homeassistant.example.internal {
	tls /etc/caddy/letsencrypt/homeassistant-fullchain.pem /etc/caddy/letsencrypt/homeassistant-privkey.pem
	import access_log

	route {
		crowdsec
		reverse_proxy 10.0.1.136:8123
	}
}

# =============================================
# Internal-only services (LAN only, not in Cloudflare Tunnel)
# =============================================

# --- *arr / Media Management ---

sonarr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:8989
	}
}

radarr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:7878
	}
}

prowlarr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:9696
	}
}

jellystat.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:3006
	}
}

dispatcharr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:9191
	}
}

huntarr.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:9705
	}
}

# --- Dashboards / Monitoring ---

homepage.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:3010
	}
}

grafana.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:3000
	}
}

prometheus.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:9090
	}
}

# --- Tools ---

wiki.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:3001
	}
}

cyberchef.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:8000
	}
}

tools.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:8080
	}
}

pdf.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.100:8088
	}
}

# --- Infrastructure (HTTPS backends, self-signed certs) ---

wazuh.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.14:443 {
			transport http {
				tls_insecure_skip_verify
			}
		}
	}
}

proxmox.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.13:8006 {
			transport http {
				tls_insecure_skip_verify
			}
		}
	}
}

unifi.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.3:8443 {
			transport http {
				tls_insecure_skip_verify
			}
		}
	}
}

opnsense.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.1:443 {
			transport http {
				tls_insecure_skip_verify
			}
		}
	}
}

dns.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.2:5380
	}
}

greenbone.example.internal {
	import cloudflare_tls
	import access_log
	route {
		crowdsec
		import authentik
		reverse_proxy 10.0.1.24:9392 {
			transport http {
				tls_insecure_skip_verify
			}
		}
	}
}
